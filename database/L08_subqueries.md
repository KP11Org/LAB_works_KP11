# **Лабораторная работа №8 (2 урока)**  
## **Тема: Подзапросы (Subqueries). Вложенные SELECT**

---

### **1. Немного теории**

**Подзапрос (subquery)** — это SQL-запрос, вложенный внутрь другого запроса. Он выполняется **сначала**, а его результат используется во внешнем запросе.

Подзапросы могут использоваться:
- В `SELECT` — для вычисления значений.
- В `FROM` — как временная таблица.
- В `WHERE` — для фильтрации по результатам другого запроса.

**Пример:**
```sql
SELECT name FROM Students 
WHERE age = (SELECT MAX(age) FROM Students);
```
— Найти студента с максимальным возрастом.

**Важно:**
- Подзапрос заключается в скобки `( )`.
- Должен возвращать **одно значение**, если используется с операторами `=`, `>`, `<` и т.д.
- Для множественных значений — используются `IN`, `ANY`, `ALL`.

---

### **2. Практическая часть**

**Цель:** Научиться использовать подзапросы для сложных фильтраций и анализа данных.

#### **Шаг 1: Подключение к базе данных**
1. Запустите **SQLite Studio**.
2. Откройте базу `students.db`.
3. Убедитесь, что таблицы `Students`, `Groups`, `Teachers` содержат данные.

#### **Шаг 2: Подзапрос в WHERE — найти самого старшего студента**
1. Сначала найдём максимальный возраст:
```sql
SELECT MAX(age) FROM Students;
```
2. Теперь используем это значение в основном запросе:
```sql
SELECT name, age 
FROM Students 
WHERE age = (SELECT MAX(age) FROM Students);
```
3. Результат: имя и возраст самого старшего студента.

#### **Шаг 3: Подзапрос с условием IN**
1. Найдём всех студентов из групп, относящихся к специальности "Информационные технологии":
```sql
SELECT name, group_id 
FROM Students 
WHERE group_id IN (SELECT id FROM Groups WHERE specialty = 'Информационные технологии');
```
2. Объяснение: сначала выбираются `id` нужных групп, затем — студенты с такими `group_id`.

#### **Шаг 4: Подзапрос в SELECT**
1. Выведем имя каждого студента и **средний возраст по его группе**:
```sql
SELECT 
    s.name,
    s.age,
    (SELECT AVG(age) FROM Students WHERE group_id = s.group_id) AS avg_group_age
FROM Students s;
```
2. Здесь `s` — псевдоним таблицы `Students`.
3. Для каждого студента вычисляется средний возраст в его группе.

#### **Шаг 5: Подзапрос в FROM**
1. Создадим временную таблицу с группами первого курса:
```sql
SELECT 
    sub.group_name,
    sub.student_count
FROM 
    (SELECT 
        g.group_name,
        COUNT(*) AS student_count
     FROM Students s
     INNER JOIN Groups g ON s.group_id = g.id
     GROUP BY g.group_name) AS sub
WHERE sub.student_count > 1;
```
2. Подзапрос в `FROM` должен иметь **псевдоним (AS sub)**.
3. Результат: группы с более чем одним студентом.

#### **Шаг 6: Подзапрос с агрегатом и JOIN**
1. Найдём преподавателей, у которых стаж больше, чем **средний стаж всех преподавателей**:
```sql
SELECT full_name, experience
FROM Teachers
WHERE experience > (SELECT AVG(experience) FROM Teachers);
```

#### **Шаг 7: Подзапрос для фильтрации по среднему в группе**
1. Найдём студентов, чей возраст **выше среднего по их группе**:
```sql
SELECT 
    s1.name,
    s1.age,
    s1.group_id
FROM Students s1
WHERE s1.age > (
    SELECT AVG(s2.age)
    FROM Students s2
    WHERE s2.group_id = s1.group_id
);
```
2. Это **коррелированный подзапрос** — он зависит от внешнего запроса (`s1.group_id`).

---

### **3. Самостоятельная часть**

> Выполняется самостоятельно.

1. Найдите **имя студента с минимальным возрастом** с помощью подзапроса.

2. Выведите всех преподавателей, которые **ведут предметы, по которым учатся студенты старше 20 лет**.  
   (Подсказка: используйте `IN` и соединение через `Groups` и предметы — придумайте логическую связь, например, добавьте поле `subject` в `Groups`, если нужно.)

3. Создайте запрос, который показывает **название группы и количество студентов в ней**, но только для тех групп, где количество больше среднего по всем группам.  
   (Среднее количество = общее число студентов / количество групп)

---

### **4. Контрольные вопросы**

1. Что такое коррелированный подзапрос?  
2. Почему подзапрос должен быть в скобках?

> Ответы дайте устно при защите работы.

---

### **5. Слепая печать**

1. Перейдите на сайт [stamina-online](https://stamina-online.com/ru/programming)
2. Пройдите два урока по [языку программирования SQL](https://stamina-online.com/ru/workout/programming/18)

---

### **6. Критерии оценивания**

| Критерий                  | Оценка | Примечание |
|---------------------------|--------|------------|
| Практическая часть        | 3      | Подзапросы используются корректно, результаты верны |
| Слепая печать             | 4      | Работа выполнена |
| Самостоятельная часть     | 5      | Запросы с подзапросами составлены правильно, включая IN, FROM, коррелированные — без синтаксических ошибок |
