# **Лабораторная работа №6 (2 урока)**  
## **Тема: Группировка данных. GROUP BY и HAVING**

---

### **1. Немного теории**

Когда нужно **анализировать данные по категориям**, например:  
- "Сколько студентов в каждой группе?"  
- "Какой средний возраст в каждой группе?"  

— используется оператор **`GROUP BY`**.

Он **объединяет строки** с одинаковыми значениями в указанном столбце и позволяет применять агрегатные функции к каждой группе.

**Важно:**  
- Все столбцы в `SELECT`, не входящие в агрегатные функции, **должны быть указаны в `GROUP BY`**.
- `WHERE` фильтрует строки **до** группировки.
- `HAVING` фильтрует **группы после** группировки (аналог `WHERE`, но для агрегатов).

**Пример:**
```sql
SELECT group_name, COUNT(*) 
FROM Students 
GROUP BY group_name;
```

---

### **2. Практическая часть**

**Цель:** Научиться группировать данные по полям и фильтровать группы с помощью `HAVING`.

#### **Шаг 1: Подключение к базе данных**
1. Запустите **SQLite Studio**.
2. Откройте базу `students.db`.
3. Убедитесь, что в таблице `Students` есть данные с разными значениями в поле `group_name`.

#### **Шаг 2: Подсчёт студентов по группам**
1. Введите запрос:
```sql
SELECT group_name, COUNT(*) AS student_count
FROM Students
GROUP BY group_name;
```
2. Результат: список групп и количество студентов в каждой.

#### **Шаг 3: Средний возраст по группам**
1. Найдём средний возраст студентов в каждой группе:
```sql
SELECT group_name, AVG(age) AS average_age
FROM Students
GROUP BY group_name;
```
2. Результат: каждая группа и её средний возраст.

#### **Шаг 4: Минимальный и максимальный возраст по группам**
1. Выведите минимум и максимум по группам:
```sql
SELECT 
    group_name,
    MIN(age) AS min_age,
    MAX(age) AS max_age
FROM Students
GROUP BY group_name;
```
2. Полезно для анализа разброса возрастов.

#### **Шаг 5: Использование HAVING**
1. Покажем только те группы, в которых **больше одного студента**:
```sql
SELECT group_name, COUNT(*) AS count
FROM Students
GROUP BY group_name
HAVING COUNT(*) > 1;
```
2. Обратите внимание: `HAVING` используется вместо `WHERE`, потому что фильтрация идёт по **результату агрегатной функции**.

#### **Шаг 6: Фильтрация по среднему возрасту**
1. Покажем группы, где **средний возраст больше 20**:
```sql
SELECT group_name, AVG(age) AS avg_age
FROM Students
GROUP BY group_name
HAVING AVG(age) > 20;
```
2. Это невозможно сделать через `WHERE`, так как среднее считается **после** группировки.

#### **Шаг 7: Комбинирование WHERE и HAVING**
1. Сначала отфильтруем студентов младше 22 лет, затем сгруппируем и покажем только группы с более чем одним студентом:
```sql
SELECT group_name, COUNT(*) AS count, AVG(age) AS avg_age
FROM Students
WHERE age < 22
GROUP BY group_name
HAVING COUNT(*) > 1;
```
2. Порядок важен:
   - `WHERE` — до группировки (фильтр по строкам)
   - `GROUP BY` — группировка
   - `HAVING` — после группировки (фильтр по группам)

#### **Шаг 8: Группировка преподавателей по предмету**
1. Допустим, в таблице `Teachers` есть поле `subject`. Сгруппируем по нему:
```sql
SELECT subject, COUNT(*) AS teacher_count
FROM Teachers
GROUP BY subject;
```
2. Если у вас ещё нет данных с разными предметами — добавьте несколько:
```sql
INSERT INTO Teachers (full_name, subject, experience) VALUES
('Анна Волкова', 'Базы данных', 7),
('Дмитрий Лебедев', 'Базы данных', 5),
('Ольга Петрова', 'Математика', 8);
```

---

### **3. Самостоятельная часть**

> Выполняется самостоятельно.

1. Выведите список групп и **количество студентов** в каждой, но только для групп, где **минимальный возраст студента ≥ 20**.

2. Найдите, **по каким предметам** работает более одного преподавателя.

3. Покажите группы, в которых **средний возраст студента больше 19**, и отсортируйте результат по убыванию этого среднего.

---

### **4. Контрольные вопросы**

1. Чем отличается `WHERE` от `HAVING`?  
2. Почему нельзя использовать агрегатную функцию в `WHERE`?

> Ответы дайте устно при защите работы.

---

### **5. Слепая печать**

1. Перейдите на сайт [stamina-online](https://stamina-online.com/ru/programming)
2. Пройдите два урока по [языку программирования SQL](https://stamina-online.com/ru/workout/programming/18)

---

### **6. Критерии оценивания**

| Критерий                  | Оценка | Примечание |
|---------------------------|--------|------------|
| Практическая часть        | 3      | Все запросы с GROUP BY и HAVING выполнены корректно |
| Слепая печать             | 4      | Работа выполнена |
| Самостоятельная часть     | 5      | Запросы составлены правильно, использованы WHERE + HAVING, синтаксис соблюдён |
