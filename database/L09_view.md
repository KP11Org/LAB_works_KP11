# **Лабораторная работа №9 (2 урока)**  
## **Тема: Индексы, представления (VIEW), транзакции**

---

### **1. Немного теории**

На этом этапе мы переходим к **оптимизации и улучшению структуры базы данных**.  
Рассмотрим три важных инструмента:

---

#### **1. Индексы (Indexes)**
- Ускоряют выполнение запросов по определённому столбцу (например, `WHERE`, `JOIN`, `ORDER BY`).
- Работают как "оглавление" книги.
- Создаются командой `CREATE INDEX`.
- Пример: индекс по `group_id` ускорит поиск студентов по группе.

⚠️ Минус: замедляют `INSERT`, `UPDATE`, `DELETE` (индекс нужно обновлять).

---

#### **2. Представления (VIEW)**
- Это **виртуальная таблица**, созданная на основе SQL-запроса.
- Не хранит данные, а хранит запрос.
- Удобно для сложных, часто используемых выборок.
- Синтаксис:  
  ```sql
  CREATE VIEW имя_представления AS
  SELECT ...
  ```

---

#### **3. Транзакции (Transactions)**
- Группировка нескольких операций в **единый блок**, который либо выполняется полностью, либо откатывается.
- Обеспечивает целостность данных.
- Команды:
  - `BEGIN TRANSACTION` — начало транзакции
  - `COMMIT` — подтверждение изменений
  - `ROLLBACK` — откат изменений

Пример: перевод баллов между студентами — если что-то пошло не так, всё откатится.

---

### **2. Практическая часть**

**Цель:** Научиться создавать индексы, представления и работать с транзакциями.

#### **Шаг 1: Создание индекса**
1. Откройте `students.db` в SQLite Studio.
2. Перейдите во вкладку **"SQL"**.
3. Создайте индекс по `group_id` в таблице `Students`:
```sql
CREATE INDEX idx_students_group_id 
ON Students (group_id);
```
4. Проверьте: в левой панели разверните таблицу `Students` → вкладка **"Indexes"** → должен появиться `idx_students_group_id`.

#### **Шаг 2: Создание индекса по имени**
1. Ускорим поиск по имени:
```sql
CREATE INDEX idx_students_name 
ON Students (name);
```
2. Теперь запросы вида `WHERE name = 'Иван'` будут работать быстрее.

#### **Шаг 3: Создание VIEW — список студентов с названием группы**
1. Создадим удобное представление для отчётов:
```sql
CREATE VIEW StudentGroupView AS
SELECT 
    s.name,
    s.age,
    g.group_name,
    g.specialty,
    g.course
FROM Students s
INNER JOIN Groups g ON s.group_id = g.id;
```
2. Выполните запрос.

#### **Шаг 4: Использование VIEW**
1. Теперь можно просто писать:
```sql
SELECT * FROM StudentGroupView;
```
2. Или фильтровать:
```sql
SELECT * FROM StudentGroupView 
WHERE course = 1;
```

#### **Шаг 5: Создание VIEW — статистика по группам**
1. Создадим представление с количеством студентов:
```sql
CREATE VIEW GroupStatsView AS
SELECT 
    g.group_name,
    g.specialty,
    COUNT(s.id) AS student_count,
    AVG(s.age) AS avg_age
FROM Groups g
LEFT JOIN Students s ON g.id = s.group_id
GROUP BY g.id;
```
2. Просмотрите результат:
```sql
SELECT * FROM GroupStatsView;
```

#### **Шаг 6: Начало транзакции**
1. Представим, что мы хотим изменить группу у двух студентов как единое действие:
```sql
BEGIN TRANSACTION;
```

#### **Шаг 7: Выполнение операций в транзакции**
1. Обновим двух студентов:
```sql
UPDATE Students SET group_id = 3 WHERE id = 1;
UPDATE Students SET group_id = 1 WHERE id = 2;
```
2. Пока не нажато `COMMIT`, изменения **не окончательны**.

#### **Шаг 8: Подтверждение (COMMIT) или откат (ROLLBACK)**
1. Если всё в порядке:
```sql
COMMIT;
```
— изменения сохраняются.

2. Если нужно отменить:
```sql
ROLLBACK;
```
— все изменения в транзакции отменяются.

> ⚠️ После `COMMIT` или `ROLLBACK` транзакция завершается.

#### **Шаг 9: Тестирование ROLLBACK**
1. Начните новую транзакцию:
```sql
BEGIN TRANSACTION;
```
2. Измените возраст студента:
```sql
UPDATE Students SET age = 99 WHERE id = 1;
```
3. Проверьте данные:
```sql
SELECT * FROM Students WHERE id = 1;
```
— возраст стал 99?
4. Теперь откатите:
```sql
ROLLBACK;
```
5. Снова выполните `SELECT` — возраст вернулся к прежнему значению.

---

### **3. Самостоятельная часть**

> Выполняется самостоятельно.

1. Создайте индекс по полю `specialty` в таблице `Groups`.

2. Создайте представление `ExperiencedTeachers`, которое показывает преподавателей со стажем больше 5 лет.

3. Выполните транзакцию: увеличьте возраст двух студентов на 1 год. Подтвердите изменения с помощью `COMMIT`.

---

### **4. Контрольные вопросы**

1. Зачем нужны индексы? Когда они могут навредить?  
2. Чем отличается `VIEW` от обычной таблицы?

> Ответы дайте устно при защите работы.

---

### **5. Слепая печать**

1. Перейдите на сайт [stamina-online](https://stamina-online.com/ru/programming)
2. Пройдите два урока по [языку программирования SQL](https://stamina-online.com/ru/workout/programming/18)

---

### **6. Критерии оценивания**

| Критерий                  | Оценка | Примечание |
|---------------------------|--------|------------|
| Практическая часть        | 3      | Индексы, VIEW и транзакции созданы и протестированы |
| Слепая печать             | 4      | Работа выполнена |
| Самостоятельная часть     | 5      | Все элементы реализованы корректно, транзакция завершена, VIEW работает |
